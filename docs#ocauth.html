<!- Copyright 2009, UCAR/Unidata and OPeNDAP, Inc. --> 
<!- See the COPYRIGHT file for more information. --> 
<html> 
<style> 
.break { page-break-before: always; } 
body { counter-reset: H2; font-size: 12pt; } 
h2:before { 
  content: counter(H2) " "; 
  counter-increment: H2; 
} 
h2 { counter-reset: H3; } 
h3:before { 
  content: counter(H2) "." counter(H3) " "; 
  counter-increment:H3; 
} 
h3 { counter-reset: H4; } 
h4:before { 
  content: counter(H2) "." counter(H3) "." counter(H4) " "; 
  counter-increment:H4; 
} 
h5 {font-size: 14pt; } /* For Appendices */ 
h6 {font-size: 16pt; } /* For Subtitles */ 
</style> 
<body> 
 
<center> 
<h1>OC Authorization Support</h1> 
<h6>Author: Dennis Heimbigner (dmh at ucar dot edu)</h6>
<h6>Draft: 11/21/2014<br> 
Last Revised: 11/21/2014<br> 
OC Version 2.0</h6> 
</center> 
 
<h6 class="break"><u>Table of Contents</u></h6> 
<ol> 
<li> <a href="#Introduction">Introduction</a> 
<li> <a href="#URL-AUTH">URL-Based Authentication</a> 
<li> <a href="#DODSRC">RC File Authentication</a> 
<li> <a href="#URLCONS">URL Constrained Entries</a> 
<li> <a href="#CLIENTCERTS">Client-Side Certificates</a> 
<li> <a href="#allkeys">Appendix A. All RC-File Keys</a>
<li> <a href="#ESGDETAIL">Appendix B. ESG Access in Detail</a>
</ol> 
 
<h2 class="break"><a name="Introduction"><u>Introduction</u></a></h2> 
OC can support user authorization using those provided by the curl
library. This includes basic password authentication as well as
certificate-based authorization.
<p>
The libcurl authorization mechanisms can be accessed in two ways
<ol>
<li> Inserting the username and password into the url, or
<li> Accessing information from a <i>.dodsrc</i> file.
</ol>

<h2 class="break"><a name="URL-AUTH"><u>URL-Based Authentication</u></a></h2> 
For simple password based authentication, it is possible to
directly insert the username and the password into a url in this form.
<pre>
    http://username:password@host/...
</pre>
This username and password will be used if the server asks for
authentication. Note that only simple password authentication
is supported in this format.

<h2 class="break"><a name="DODSRC"><u>RC File Authentication</u></a></h2> 
The oc library supports an rc-file mechanism to allow the passing
of a number of parameters to libcurl.
<p>
The file must be called one of the following names:
".dodsrc", ".ocsrc"
in order; that is, if both .ocrc and .dodsrc exist, then
the .dodsrc file will be used.
<p>
Searching for the rc file first looks in the current directory
and then in the home directory (as defined by the HOME environment
variable). It is also possible to specify a direct path using
the <i>-R</i> option to ocprint or using the <i>oc_set_rcfile</i>
procedure (see oc.h).
<p>
The rc file format is a series of lines of the general form:
<pre>
[<url>]<key>=<value>
</pre>
where the bracket-enclosed url is optional and will be discussed 
subsequently.
<p>
The currently defined set of authorization-related keys are as follows.
The second column is the affected curl_easy_setopt option(s).
<table>
<tr><th>Key<th>curl_easy_setopt Option
<tr><td>HTTP.COOKIEJAR<td>CUROPT_COOKIEJAR, CURLOPT_COOKIEFILE
<tr><td>HTTP.COOKIE_JAR<td>same as HTTP.COOKIEJAR
<tr><td>HTTP.PROXY_SERVER<td>CURLOPT_PROXY, CURLOPT_PROXYPORT, CURLOPT_PROXYUSERPWD
<tr><td>HTTP.SSL.CERTIFICATE<td>CUROPT_SSLCERT
<tr><td>HTTP.SSL.KEY<td>CUROPT_SSLKEY
<tr><td>HTTP.SSL.KEYPASSWORD<td>CUROPT_KEYPASSWORD
<tr><td>HTTP.SSL.CAINFO<td>CUROPT_SSLCAINFO
<tr><td>HTTP.SSL.CAPATH<td>CUROPT_SSLCAPATH
<tr><td>HTTP.SSL.VERIFYPEER<td>CUROPT_SSL_VERIFYPEER
<tr><td>HTTP.CREDENTIALS.USER<td>CUROPT_USERPASSWORD
<tr><td>HTTP.CREDENTIALS.PASSWORD<td>CUROPT_USERPASSWORD
<tr><td>HTTP.CREDENTIALS.USERPASSWORD<td>CUROPT_USERPASSWORD
</ul>

<h3><u>Password Authentication</u></h3> 
The three keys, 
HTTP.CREDENTIALS.USER,
HTTP.CREDENTIALS.PASSWORD.
and
HTTP.CREDENTIALS.USERPASSWORD
can be used to set the simple password authentication.
The first two will be combined internally to produce
a combined authentication of the form "username:password".
The last key takes that combination directlry.

<h3><u>Cookie Jar</u></h3> 
The HTTP.COOKIEJAR key
specified the name of file from which
to read cookies (CURLOPT_COOKIEJAR) and also
the file into which to store cookies (CURLOPT_COOKIEFILE).
The same value is used for both CURLOPT values.
It defaults to in-memory storage.

<h3><u>Certificate Authentication</u></h3> 
HTTP.SSL.CERTIFICATE
specifies a file path for a file containing a PEM cerficate.
This is typically used for client-side authentication.
<p>
HTTP.SSL.KEY is essentially the same as HTTP.SSL.CERTIFICATE
and should usually have the same value.
<p>
HTTP.SSL.KEYPASSWORD
specifies the password for accessing the HTTP.SSL.KEY/HTTP.SSL.CERTIFICATE
file.
<p>
HTTP.SSL.CAPATH
specifies the path to a directory containing
trusted certificates for validating server sertificates.
<p>
HTTP.SSL.VALIDATE
is a boolean (1/0) value that if true (1)
specifies that the client should verify the server's presented certificate.
<p>
HTTP.PROXY_SERVER
specified the url for accessing the proxy:
(e.g.http://[username:password@]host[:port])

<h2 class="break"><a name="URLCONS"><u>URL Constrained Entries</u></a></h2> 
Each line of the rc file can begin with
some prefix of a url enclosed in square brackets.
For example:
<pre>
[http://remotetest.unidata.ucar.edu/thredds/dodsC]HTTP.VERBOSE=1
or
[http://remotetest.unidata.ucar.edu]HTTP.VERBOSE=0
</pre>
If the url request from, say, the <i>oc_open</i> method
starts with one of the prefixes in the rc file, then
the corresponding entry will be used, otherwise ignored.
If multiple prefixes match, then the longest match will be used.
<p>
For example, the URL
<pre>
http://remotetest.unidata.ucar.edu/thredds/dodsC/testdata/testData.nc
</pre>
will have HTTP.VERBOSE set to 1 because 
<pre>
http://remotetest.unidata.ucar.edu/thredds/dodsC
</pre>
is a prefix of our url passed to <i>oc_open</i>.
<p>
Similarly, 
<pre>
http://remotetest.unidata.ucar.edu/dts/test.01
</pre>
will have HTTP.VERBOSE set to 0.

<h2 class="break"><a name="CLIENTCERTS"><u>Client-Side Certificates</u></a></h2> 
Some systems, notably ESG (Earth System Grid), requires
the use of client-side certificates.
This reqires setting the following entries:
<pre>
    HTTP.SSL.VALIDATE
    HTTP.COOKIEJAR
    HTTP.SSL.CERTIFICATE
    HTTP.SSL.KEY
    HTTP.SSL.CAPATH
</pre>
As a rule,the HTTP>SSL.CERTIFICATE and HTTP.SSL.KEY
entries should have the same value, which is the file path for the
client side certificate. The HTTP.SSL.CAPATH entry should
be the path to a "certificates" directory.

<h5 class="break"><a name="allkeys"><u>Appendix A. All RC-File Keys</u></a></h5> 
For completeness, this is the list of all rc-file keys.
<table>
<tr><th>Key<th>curl_easy_setopt Option
<tr><td>HTTP.DEFLATE<td>CUROPT_DEFLATE with value "deflate,gzip"
<tr><td>HTTP.VERBOSE <td>CUROPT_VERBOSE 
<tr><td>HTTP.TIMEOUT<td>CUROPT_TIMEOUT
<tr><td>HTTP.USERAGENT<td>CUROPT_USERAGENT
<tr><td>HTTP.COOKIEJAR<td>CUROPT_COOKIEJAR
<tr><td>HTTP.COOKIE_JAR<td>CUROPT_COOKIEJAR
<tr><td>HTTP.PROXY_SERVER<td>CURLOPT_PROXY, CURLOPT_PROXYPORT, CURLOPT_PROXYUSERPWD
<tr><td>HTTP.SSL.CERTIFICATE<td>CUROPT_SSLCERT
<tr><td>HTTP.SSL.KEY<td>CUROPT_SSLKEY
<tr><td>HTTP.SSL.KEYPASSWORD<td>CUROPT_KEYPASSWORD
<tr><td>HTTP.SSL.CAINFO<td>CUROPT_SSLCAINFO
<tr><td>HTTP.SSL.CAPATH<td>CUROPT_SSLCAPATH
<tr><td>HTTP.SSL.VERIFYPEER<td>CUROPT_SSL_VERIFYPEER
<tr><td>HTTP.CREDENTIALS.USER<td>CUROPT_USERPASSWORD
<tr><td>HTTP.CREDENTIALS.PASSWORD<td>CUROPT_USERPASSWORD
<tr><td>HTTP.CREDENTIALS.USERPASSWORD<td>CUROPT_USERPASSWORD
</ul>

<h5 class="break"><a name="ESGDETAIL"><u>Appendix B. ESG Access in Detail</u></a></h5> 
It is possible to access Earth Systems Grid (ESG) datasets
from ESG servers through the OC API using the rc file.
<p>
In order to access ESG datasets, however, it is necessary to
register as a user with ESG and to setup your environment
so that proper authentication is established between an oc
client program and the ESG data server.  Specifically, it
is necessary to use what is called "client-side keys" to
enable this authentication. Normally, when a client accesses
a server in a secure fashion (using "https"), the server
provides an authentication certificate to the client.
With client-side keys, the client must also provide a
certificate to the server so that the server can know with
whom it is communicating.
<p>
It is possible to set up the oc library to use
client-side keys, although the process is 
somewhat complicated. The oc library
uses the <i>curl</i> library and it is that underlying library
that must be properly configured.

<h3><u>Terminology</u></h3>
The key elements for client-side keys requires the constructions of
two "stores" on the client side.
<ul>
<li> Keystore - a repository to hold the client side key.
<li> Truststore - a repository to hold a chain of certificates
                  that can be used to validate the certificate
		  sent by the server to the client.
</ul>
The server actually has a similar set of stores, but the client
need not be concerned with those.

<h3><u>Initial Steps</u></h3>

The first step is to obtain authorization from ESG.
Note that this information may evolve over time, and
may be out of date.
This discussion is in terms of BADC ESG. You will need
to substitute the ESG site for BADC in the following.
<ol>
<li> Register at http://badc.nerc.ac.uk/register
   to obtain access to badc and to obtain an openid,
   which will looks something like:
   <pre>https://ceda.ac.uk/openid/Firstname.Lastname</pre>
<li> Ask BADC for access to whatever datasets are of interest.
<p>
<li> Obtain short term credentials at
   http://grid.ncsa.illinois.edu/myproxy/MyProxyLogon/
   You will need to download and run the MyProxyLogon
   program.
   This will create a keyfile in, typically, the directory ".globus".
   The keyfile will have a name similar to this: "x509up_u13615"
   The other elements in ".globus" are certificates to use in
   validating the certificate your client gets from the server.
<p>
<li> Obtain the program source ImportKey.java
   from this location: http://www.agentbob.info/agentbob/79-AB.html
   (read the whole page, it will help you understand the remaining steps).
</ol>

<h3><u>Building the KeyStore</u></h3>
You will have to modify the keyfile in the previous step
and then create a keystore and install the key and a certificate.
The commands are these:
<pre>
    openssl pkcs8 -topk8 -nocrypt -in x509up_u13615 -inform PEM -out key.der -outform DER

    openssl x509 -in x509up_u13615 -inform PEM -out cert.der -outform DER

    java -classpath <path to ImportKey.class> -Dkeypassword="<password>" -Dkeystore=./<keystorefilename> key.der cert.der
</pre>     
Note, the file names "key.der" and "cert.der" can be whatever you choose.
It is probably best to leave the .der extension, though.

<h3><u>Building the TrustStore</u></h3>
Building the truststore is a bit tricky because as provided, the
certificates in ".globus" need some massaging. See the script below
for the details. The primary command is this, which is executed for every
certificate, c, in globus. It sticks the certificate into the file
named "truststore"
<pre>
  keytool -trustcacerts -storepass "password" -v -keystore "truststore"  -importcert -file "${c}"
</pre>

<h3><u>Running the C Client</u></h3>

The following keys must be set in the rc file to support
ESG access.
<ul>
<li> HTTP.SSL.VALIDATE=1
<li> HTTP.COOKIEJAR=.dods_cookies
<li> HTTP.SSL.CERTIFICATE=esgkeystore
<li> HTTP.SSL.KEY=esgkeystore
<li> HTTP.SSL.CAPATH=.globus
</ul>
For ESG, the HTTP.SSL.CERTIFICATE and HTTP.SSL.KEY
entries should have same value, which is the file path for the
certificate produced by MyProxyLogon.  The HTTP.SSL.CAPATH entry
should be the path to the "certificates" directory produced by
MyProxyLogon.
<p>
As an aside, note that ESG operates by redirection. That is,
when it receives an initial connection from a client, it
redirects to a separate authentication server. When that
server has authenticated the client, it redirects back to
the original url to complete the request.

<h3><u>Script for creating Stores</u></h3>
The following script shows in detail how to actually construct the key
and trust stores. It is specific to the format of the globus file
as it was when ESG support was first added. It may have changed
since then, in which case, you will need to seek some help
in fixing this script. It would help if you communicated
what you changed to the author so this document can be updated.
<pre>
#!/bin/sh -x
KEYSTORE="esgkeystore"
TRUSTSTORE="esgtruststore"
GLOBUS="globus"
TRUSTROOT="certificates"
CERT="x509up_u13615"
TRUSTROOTPATH="$GLOBUS/$TRUSTROOT"
CERTFILE="$GLOBUS/$CERT"
PWD="password"

D="-Dglobus=$GLOBUS"
CCP="bcprov-jdk16-145.jar" 
CP="./build:${CCP}" 
JAR="myproxy.jar"

# Initialize needed directories
rm -fr build
mkdir build
rm -fr $GLOBUS
mkdir $GLOBUS
rm -f $KEYSTORE
rm -f $TRUSTSTORE

# Compile MyProxyCmd and ImportKey
javac -d ./build -classpath "$CCP" *.java
javac -d ./build ImportKey.java

# Execute MyProxyCmd
java -cp "$CP myproxy.MyProxyCmd

# Build the keystore
openssl pkcs8 -topk8 -nocrypt -in $CERTFILE -inform PEM -out key.der -outform DER
openssl x509 -in $CERTFILE -inform PEM -out cert.der -outform DER
java -Dkeypassword=$PWD -Dkeystore=./${KEYSTORE} -cp ./build ImportKey key.der cert.der

# Clean up the certificates in the globus directory
for c in ${TRUSTROOTPATH}/*.0 ; do
    alias=`basename $c .0`
    sed -e '0,/---/d' <$c >/tmp/${alias}
    echo "-----BEGIN CERTIFICATE-----" >$c       
    cat /tmp/${alias} >>$c
done
 
# Build the truststore
for c in ${TRUSTROOTPATH}/*.0 ; do
    alias=`basename $c .0`
    echo "adding: $TRUSTROOTPATH/${c}"
    echo "alias: $alias"
    yes | keytool -trustcacerts -storepass "$PWD" -v -keystore ./$TRUSTSTORE -alias $alias -importcert -file "${c}"
done
exit
</pre>

</body> 
</html> 
